steps:
# Step 1: Build Docker image
- name: 'gcr.io/cloud-builders/docker'
  args: [
    'build', 
    '-t', 'asia-southeast1-docker.pkg.dev/sg-job-market/nlp-embeddings-docker/sg-job-embeddings:latest', 
    '-f', 'Dockerfile.embeddings', 
    '.'
  ]

# Step 2: Scan for vulnerabilities with Trivy
- name: 'aquasec/trivy:latest'
  args:
    - 'image'
    - '--severity=HIGH,CRITICAL'
    - '--exit-code=1'
    - '--ignore-unfixed'
    - '--scanners=vuln'
    - '--pkg-types=library'
    - '--no-progress'
    - '--timeout=10m'
    - 'asia-southeast1-docker.pkg.dev/sg-job-market/nlp-embeddings-docker/sg-job-embeddings:latest'
  timeout: 600s

images:
- 'asia-southeast1-docker.pkg.dev/sg-job-market/nlp-embeddings-docker/sg-job-embeddings:latest'
